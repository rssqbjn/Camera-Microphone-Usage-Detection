<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>摄像头 / 麦克风 开启与关闭</title>
  <style>
    :root {
      --bg: #0f172a; /* slate-900 */
      --panel: #111827; /* gray-900 */
      --muted: #6b7280; /* gray-500 */
      --text: #e5e7eb; /* gray-200 */
      --accent: #3b82f6; /* blue-500 */
      --accent-2: #10b981; /* emerald-500 */
      --danger: #ef4444; /* red-500 */
      --ring: #93c5fd; /* blue-300 */
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; background: radial-gradient(1200px 600px at 50% -10%, #1f2937, var(--bg));
      color: var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      display: grid; place-items: center; padding: 24px;
    }
    .app { width: min(980px, 100%); }
    .card {
      background: linear-gradient(180deg, #0b1220, var(--panel));
      border-radius: 18px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.06);
    }
    h1 { font-size: 20px; margin: 0 0 14px; letter-spacing: .4px; }
    p.note { margin: 6px 0 18px; color: var(--muted); font-size: 14px; }
    .grid { display: grid; grid-template-columns: 1fr 320px; gap: 16px; }
    video { width: 100%; aspect-ratio: 16/9; background: #0b1220; border-radius: 14px; border: 1px solid rgba(255,255,255,.08); }
    .panel { background: rgba(255,255,255,.03); border-radius: 14px; padding: 14px; border: 1px solid rgba(255,255,255,.06); }

    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    button {
      appearance: none; border: 1px solid rgba(255,255,255,.08); color: var(--text); background: rgba(255,255,255,.04);
      padding: 10px 14px; border-radius: 12px; cursor: pointer; font-weight: 600; letter-spacing: .3px;
      transition: transform .05s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease;
    }
    button:hover { background: rgba(255,255,255,.08); }
    button:active { transform: translateY(1px); }
    .primary { border-color: rgba(59,130,246,.6); box-shadow: 0 0 0 3px rgba(59,130,246,.15) inset; }
    .success { border-color: rgba(16,185,129,.6); box-shadow: 0 0 0 3px rgba(16,185,129,.15) inset; }
    .danger { border-color: rgba(239,68,68,.6); box-shadow: 0 0 0 3px rgba(239,68,68,.15) inset; }

    .meters { margin-top: 12px; display: grid; gap: 10px; }
    .meter { height: 10px; background: rgba(255,255,255,.06); border-radius: 999px; overflow: hidden; border: 1px solid rgba(255,255,255,.08); }
    .bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); transition: width .08s linear; }

    .status { font-size: 13px; color: var(--muted); display: flex; align-items: center; gap: 8px; }
    .dot { width: 8px; height: 8px; border-radius: 999px; background: #6b7280; box-shadow: 0 0 0 3px rgba(107,114,128,.2); }
    .dot.on { background: #22c55e; box-shadow: 0 0 0 3px rgba(34,197,94,.18); }
    .dot.err { background: #ef4444; box-shadow: 0 0 0 3px rgba(239,68,68,.18); }

    details { margin-top: 10px; }
    summary { cursor: pointer; color: var(--muted); }
    code { color: #cbd5e1; }
    .small { font-size: 12px; color: var(--muted); }

    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <h1>摄像头 / 麦克风 控制台</h1>
      <p class="note">点击按钮即可 <strong>开启</strong> 或 <strong>关闭</strong> 摄像头与麦克风。第一次使用需要浏览器授权。</p>

      <div class="grid">
        <div>
          <video id="video" playsinline autoplay muted></video>
          <div class="row" style="margin-top:12px">
            <button id="startBoth" class="primary">开启 摄像头 + 麦克风</button>
            <button id="stopAll" class="danger">关闭 所有</button>
          </div>
        </div>

        <div class="panel">
          <div class="row" style="margin-bottom:8px">
            <button id="startCam" class="primary">仅开启摄像头</button>
            <button id="stopCam" class="danger">关闭摄像头</button>
          </div>
          <div class="row" style="margin-bottom:8px">
            <button id="startMic" class="success">仅开启麦克风</button>
            <button id="stopMic" class="danger">关闭麦克风</button>
          </div>

          <div class="meters">
            <div class="status"><span id="camDot" class="dot"></span> 摄像头状态：<span id="camStatus">未开启</span></div>
            <div class="status"><span id="micDot" class="dot"></span> 麦克风状态：<span id="micStatus">未开启</span></div>
            <div class="meter" title="实时音量 (仅在麦克风开启时显示)"><div id="micBar" class="bar"></div></div>
            <div id="err" class="small"></div>
          </div>

          <details>
            <summary>常见问题</summary>
            <ul class="small">
              <li>如提示“未找到设备”，请检查系统隐私设置与物理连接。</li>
              <li>使用桌面浏览器体验更佳（推荐 Chrome/Edge/Firefox/Safari 最新版）。</li>
              <li>点击“关闭”会释放媒体轨道（tracks），以停止占用设备与麦克风录制指示灯。</li>
            </ul>
          </details>
        </div>
      </div>
    </div>
  </div>

  <script>
    const videoEl = document.getElementById('video');
    const camStatus = document.getElementById('camStatus');
    const micStatus = document.getElementById('micStatus');
    const micBar = document.getElementById('micBar');
    const errBox = document.getElementById('err');
    const camDot = document.getElementById('camDot');
    const micDot = document.getElementById('micDot');

    let camStream = null; // 仅包含 video 的流
    let micStream = null; // 仅包含 audio 的流
    let audioCtx, analyser, sourceNode, dataArray, rafId;

    function setStatus(target, on) {
      target.textContent = on ? '已开启' : '未开启';
    }
    function setDot(dotEl, state) {
      dotEl.classList.remove('on', 'err');
      if (state === 'on') dotEl.classList.add('on');
      if (state === 'err') dotEl.classList.add('err');
    }
    function showError(e) {
      console.error(e);
      errBox.textContent = '错误：' + (e && e.message ? e.message : String(e));
    }
    function clearError() { errBox.textContent = ''; }

    function stopStream(stream) {
      if (!stream) return;
      stream.getTracks().forEach(t => t.stop());
    }

    async function startCamera() {
      try {
        clearError();
        if (camStream) stopStream(camStream);
        camStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        videoEl.srcObject = camStream;
        setStatus(camStatus, true); setDot(camDot, 'on');
      } catch (e) {
        setStatus(camStatus, false); setDot(camDot, 'err'); showError(e);
      }
    }

    async function startMic() {
      try {
        clearError();
        if (micStream) stopStream(micStream);
        micStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
        setStatus(micStatus, true); setDot(micDot, 'on');
        startMeter(micStream);
      } catch (e) {
        setStatus(micStatus, false); setDot(micDot, 'err'); showError(e);
      }
    }

    async function startBoth() {
      try {
        clearError();
        // 合并获取，保证同一次权限授予
        const both = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        // 拆分到 camStream / micStream 便于分别关闭
        const vTracks = both.getVideoTracks();
        const aTracks = both.getAudioTracks();
        if (camStream) stopStream(camStream);
        if (micStream) stopStream(micStream);
        camStream = new MediaStream(vTracks);
        micStream = new MediaStream(aTracks);
        videoEl.srcObject = camStream;
        setStatus(camStatus, true); setDot(camDot, 'on');
        setStatus(micStatus, true); setDot(micDot, 'on');
        startMeter(micStream);
      } catch (e) {
        if (!camStream) { setStatus(camStatus, false); setDot(camDot, 'err'); }
        if (!micStream) { setStatus(micStatus, false); setDot(micDot, 'err'); }
        showError(e);
      }
    }

    function stopCamera() {
      stopStream(camStream); camStream = null; videoEl.srcObject = null;
      setStatus(camStatus, false); setDot(camDot, '');
    }
    function stopMic() {
      stopStream(micStream); micStream = null;
      setStatus(micStatus, false); setDot(micDot, ''); stopMeter();
    }
    function stopAll() { stopCamera(); stopMic(); }

    // 音量表（RMS 近似）
    function startMeter(stream) {
      try {
        if (!window.AudioContext && !window.webkitAudioContext) return;
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        stopMeter(); // 先清理
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 512;
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        sourceNode = audioCtx.createMediaStreamSource(stream);
        sourceNode.connect(analyser);
        const loop = () => {
          analyser.getByteTimeDomainData(dataArray);
          // 计算简易 RMS
          let sum = 0;
          for (let i = 0; i < dataArray.length; i++) {
            const v = (dataArray[i] - 128) / 128; sum += v * v;
          }
          const rms = Math.sqrt(sum / dataArray.length);
          const pct = Math.min(100, Math.max(0, Math.round(rms * 160))); // 调整系数
          micBar.style.width = pct + '%';
          rafId = requestAnimationFrame(loop);
        };
        loop();
      } catch (e) { console.warn('meter error', e); }
    }
    function stopMeter() {
      micBar.style.width = '0%';
      if (rafId) cancelAnimationFrame(rafId), rafId = null;
      if (sourceNode) { try { sourceNode.disconnect(); } catch {} sourceNode = null; }
      if (analyser) { try { analyser.disconnect(); } catch {} analyser = null; }
    }

    // UI 绑定
    document.getElementById('startCam').addEventListener('click', startCamera);
    document.getElementById('stopCam').addEventListener('click', stopCamera);
    document.getElementById('startMic').addEventListener('click', startMic);
    document.getElementById('stopMic').addEventListener('click', stopMic);
    document.getElementById('startBoth').addEventListener('click', startBoth);
    document.getElementById('stopAll').addEventListener('click', stopAll);

    // 环境检测
    if (!('mediaDevices' in navigator) || !navigator.mediaDevices.getUserMedia) {
      showError(new Error('此浏览器不支持 getUserMedia。请使用最新版 Chrome/Edge/Firefox/Safari。'));
    }
  </script>
</body>
</html>
